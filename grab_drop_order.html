<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>小鱼儿助花帮平台</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="css/public.css" rel="stylesheet" type="text/css">
		<link href="css/grab_drop_order.css" rel="stylesheet" type="text/css">
		<link href="plugin/mui/css/mui.min.css" rel="stylesheet" type="text/css">
		<script src="js/public.js"></script>
		<style>
			html,
			body {background-color: #e9e9e9;}
			.mui-bar~.mui-content .mui-fullscreen {top: 44px;height: auto;}
			.mui-pull-top-tips {position: absolute;top: -20px;left: 50%;margin-left: -25px;width: 40px;height: 40px;border-radius: 100%;z-index: 1;}
			.mui-bar~.mui-pull-top-tips {top: 24px;}
			.mui-pull-top-wrapper {width: 42px;height: 42px;display: block;text-align: center;background-color: #efeff4;border: 1px solid #ddd;border-radius: 25px;background-clip: padding-box;box-shadow: 0 4px 10px #bbb;overflow: hidden;}
			.mui-pull-top-tips.mui-transitioning {-webkit-transition-duration: 200ms;transition-duration: 200ms;}
			.mui-pull-top-tips .mui-pull-loading {/*-webkit-backface-visibility: hidden;-webkit-transition-duration: 400ms;transition-duration: 400ms;*/margin: 0;}
			.mui-pull-top-wrapper .mui-icon,.mui-pull-top-wrapper .mui-spinner {margin-top: 7px;}
			.mui-pull-top-wrapper .mui-icon.mui-reverse {/*-webkit-transform: rotate(180deg) translateZ(0);*/}
			.mui-pull-bottom-tips {text-align: center;background-color: #efeff4;font-size: 15px;line-height: 40px;color: #777;}
			.mui-pull-top-canvas {overflow: hidden;background-color: #fafafa;border-radius: 40px;box-shadow: 0 4px 10px #bbb;width: 40px;height: 40px;margin: 0 auto;}
			.mui-pull-top-canvas canvas {width: 40px;}
			.mui-slider-indicator.mui-segmented-control {background-color: #efeff4;}
			.mui-fullscreen .mui-slider-group {top:0.98rem !important;}
			.mui-segmented-control.mui-scroll-wrapper{height: 0.62rem;}
			.mui-table-view-cell{padding:0;}
			.mui-table-view-cell a{color: #000;}
		</style>
	</head>
	<body>
		<div class="mui-content gd_order">
			<div id="slider" class="mui-slider mui-fullscreen">
				<!-- <div id="sliderSegmentedControl" class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll or_type">
						<a class="mui-control-item mui-active" href="#item1mobile">抢单</a>
						<a class="mui-control-item" href="#item2mobile">甩单</a>
					</div>
				</div> -->
				<div class="gd_top_cont">
		            <!-- <div class="or_type_wrap">
		                <div class="or_type">
		                    <a href="javascript:;" class="active">抢单</a><a href="javascript:;">甩单</a>
		                </div>
		            </div> -->
		            <ul class="or_filter">
		                <li class="or_city" data-id=""><span>城市</span></li>
		                <li class="or_order_type" data-id="1"><span>订单分类</span></li>
		                <!-- <li><span>筛选</span></li> -->
		            </ul>
		            <div class="gd_tips"><img src="images/grab_order_01.png" alt=""><span>VIP会员，每天都有一次免费抢单哦！</span></div>
		        </div>
		        <div class="city_wrap filter_cont">
		            <ul class="filter_l1" id="gradew">
		            </ul>
		            <ul class="filter_l2" id="gradet">
		            </ul>
		        </div>
		        <div class="order_type_wrap filter_cont">
		            <ul class="filter_l1">
		                <li data-value="1">全部订单</li>
		                <li data-value="0">可抢订单</li>
		                <!-- <li data-value="2">免费订单</li> -->
		            </ul>
		        </div>
				<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
						<div id="scroll1" class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<!-- <li class="mui-table-view-cell">
										<div class="gd_order_item">
											<a href="grab_order_details.html?contractNo=''">
							                    <div class="gd_o_row">
							                        <div class="gd_o_col gd_o_col1">
							                            <div class="gd_o_info1">
							                                <span class="gd_o_name">罗先生0</span><span class="gd_o_edu"><i>2</i>万元</span><span>北京市</span><span>月收入6000</span>
							                            </div>
							                            <div class="gd_o_info2">
							                                <img class="gd_o_flag" src="images/grab_order_04.png" alt=""><span>工薪族</span><span>无房产</span><span>有车</span><span>有社保</span><span>有公积金</span><span>有信用卡</span>
							                            </div>
							                        </div>
							                        <div class="gd_o_col gd_o_col2">
							                            <img class="gd_o_fish" src="images/grab_order_02.png" alt="">
							                            <p><span>66</span>鱼币</p>
							                        </div>
							                    </div>
							                    <div class="gd_o_row">
							                        <div class="gd_grab_btn">立即抢单</div>
							                    </div>
						                    </a>
						                </div>
									</li>-->
								</ul>
							</div>
						</div>
					</div>
					<!-- <div id="item2mobile" class="mui-slider-item mui-control-content">
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<li class="mui-table-view-cell">
										<div class="gd_order_item">
						                    <div class="gd_o_row">
						                        <div class="gd_o_col gd_o_col1">
						                            <div class="gd_o_info1">
						                                <span class="gd_o_name">罗先生0</span><span class="gd_o_edu"><i>2</i>万元</span><span>北京市</span><span>月收入6000</span>
						                            </div>
						                            <div class="gd_o_info2">
						                                <img class="gd_o_flag" src="images/grab_order_04.png" alt=""><span>工薪族</span><span>无房产</span><span>有车</span><span>有社保</span><span>有公积金</span><span>有信用卡</span>
						                            </div>
						                        </div>
						                        <div class="gd_o_col gd_o_col2">
						                            <img class="gd_o_fish" src="images/grab_order_02.png" alt="">
						                            <p><span>66</span>鱼币</p>
						                        </div>
						                    </div>
						                    <div class="gd_o_row">
						                        <a class="gd_grab_btn" href="grab_order_details.html">立即抢单</a>
						                    </div>
						                </div>
									</li>
								</ul>
							</div>
						</div>
					</div> -->
				</div>
			</div>
		</div>
		<script type="text/javascript" src="plugin/zepto/zepto.js"></script>
		<script src="plugin/mui/js/mui.min.js"></script>
		<script src="plugin/mui/js/mui.pullToRefresh.js"></script>
		<script src="plugin/mui/js/mui.pullToRefresh.material.js"></script>
		<script src="plugin/mui/js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
		<script>
			/*加载动画*/
	        var loader = new loading({'container':document.body,'hasBg':false});
	        var page = 1,pageSize = 5;
	        var openid;
	        if (!Cookie.get("xiaoyuerUserMes")) {
	            getOpenId();
	        } else {
	            var xiaoyuerUserMes = Cookie.get("xiaoyuerUserMes");
	            openid = JSON.parse(Cookie.get("xiaoyuerUserMes")).openid;
	            if (openid == undefined) {
	                getOpenId();
	            }
	        }
	        checkRegisterUser();

	        //筛选数据
            getData(1,pageSize,$('.or_city').attr('data-id'),$('.or_order_type').attr('data-id'),function(data){
				setTimeout(function() {
					page = 1;
					var ul = document.getElementsByClassName('mui-table-view')[0];
					createFragment(ul,data,true);
				}, 500);
			});
			mui.init();
			(function($) {
				//阻尼系数
				var deceleration = mui.os.ios?0.003:0.0009;
				$('.mui-scroll-wrapper').scroll({
					bounce: false,
					indicators: true, //是否显示滚动条
					deceleration:deceleration
				});
				$.ready(function() {
					//循环初始化所有下拉刷新，上拉加载。
					$.each(document.querySelectorAll('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
						$(pullRefreshEl).pullToRefresh({
							down: {
								callback: function() {
									var self = this;
									var city = document.getElementsByClassName('or_city')[0].getAttribute('data-id');
									var orderType = document.getElementsByClassName('or_order_type')[0].getAttribute('data-id');
									getData(1,pageSize,city,orderType,function(data){
										setTimeout(function() {
											page = 1;
											var ul = document.getElementsByClassName('mui-table-view')[0];
											createFragment(ul,data,true);
											self.endPullDownToRefresh();
										}, 500);
									});
								}
							},
							up: {
								callback: function() {
									var self = this;
									var city = document.getElementsByClassName('or_city')[0].getAttribute('data-id');
									var orderType = document.getElementsByClassName('or_order_type')[0].getAttribute('data-id');
									getData(page+1,pageSize,city,orderType,function(data){
										setTimeout(function() {
											page++;
											var ul = document.getElementsByClassName('mui-table-view')[0];
											createFragment(ul,data,false);
											self.endPullUpToRefresh();
										}, 500);
									});
								}
							}
						});
					});
				});
			})(mui);
			mui('body').on('tap','a',function(){document.location.href=this.href;});

			$('.or_type>a').on('click',function(){
	            $(this).siblings().removeClass('active');
	            $(this).addClass('active');
	        });
	        //省市
	        var allCityLi = $('<li data-value="">全部城市</li>');
	        allCityLi.on('click',function(e){
				$('.or_city').attr('data-id',$(this).attr('data-value'));
			    $('.or_city>span').text($(this).text());
			    $('.city_wrap').removeClass('filter_cont_show');
			    //筛选数据
	            getData(1,pageSize,$('.or_city').attr('data-id'),$('.or_order_type').attr('data-id'),function(data){
					setTimeout(function() {
						page = 1;
						var ul = document.getElementsByClassName('mui-table-view')[0];
						createFragment(ul,data,true);
					}, 500);
				});
	        });
	        $('#gradew').append(allCityLi);
	        for(var i=0;i<cityData3.length;i++){
	        	var tmpLi = $('<li data-value="'+cityData3[i].value+'">'+cityData3[i].text+'</li>');
	        	tmpLi.on('click',cityData3[i].children,function(e){
	        		if($(this).attr("data-value")){
	        			var children = e.data;
		        		$('#gradet').empty();
		        		for(var i=0;i<children.length;i++){
		        			var tmpSubLi = $('<li data-value="'+children[i].value+'">'+children[i].text+'</li>');
		        			tmpSubLi.on('click',function(e){
					            $('.or_city').attr('data-id',$(this).attr('data-value'));
					            $('.or_city>span').text($(this).text());
					            $('.city_wrap').removeClass('filter_cont_show');
					            //筛选数据
					            getData(1,pageSize,$('.or_city').attr('data-id'),$('.or_order_type').attr('data-id'),function(data){
									setTimeout(function() {
										page = 1;
										var ul = document.getElementsByClassName('mui-table-view')[0];
										createFragment(ul,data,true);
									}, 500);
								});
					        });
		        			$('#gradet').append(tmpSubLi);
		        		}
			            $(".city_wrap .filter_l2").css("left","50%");
	        		}else{
						$('.or_city').attr('data-id',$(this).attr('data-value'));
					    $('.or_city>span').text($(this).text());
	        		}
		        });
	        	$('#gradew').append(tmpLi);
	        }
	        /*选择省市*/
	        $(".or_city").on('click',function(){
	            $('.order_type_wrap').removeClass('filter_cont_show');
	            if ($('.city_wrap').hasClass('filter_cont_show')) {
	                $('.city_wrap').removeClass('filter_cont_show');
	            } else {
	                $('.city_wrap').addClass('filter_cont_show');
	            }
	        });
	        
	        /*选择订单类型*/
	        $(".or_order_type").on('click',function(){
	            $('.city_wrap').removeClass('filter_cont_show');
	            if ($('.order_type_wrap').hasClass('filter_cont_show')) {
	                $('.order_type_wrap').removeClass('filter_cont_show');
	            } else {
	                $('.order_type_wrap').addClass('filter_cont_show');
	            }
	        });
	        $(".order_type_wrap .filter_l1>li").click(function(){
	            $('.or_order_type').attr('data-id',$(this).attr('data-value'));
	            $('.or_order_type>span').text($(this).text())
	            $('.order_type_wrap').removeClass('filter_cont_show');
	            //筛选数据
	            getData(1,pageSize,$('.or_city').attr('data-id'),$('.or_order_type').attr('data-id'),function(data){
					setTimeout(function() {
						page = 1;
						var ul = document.getElementsByClassName('mui-table-view')[0];
						createFragment(ul,data,true);
					}, 500);
				});
	        });
	        //获取单页数据
	        function getData(pageNum,pageSize,applyCity,isSnatch,callback){
				var parmas = {
					userId:Cookie.get('userId'),
					//userId:'1705071237LOHDBGOCmoiswqShfqI',
					pageSize:pageSize,
					pageNo:pageNum,
					applyCity:applyCity,
					isSnatch:isSnatch
				}
				$.ajax({
                    type:"post",
                    url:Config.url+"/querySnatchList",
                    data:parmas,
                    beforeSend:function(xhr, settings){
                        loader.show();
                    },
                    success:function(data, status, xhr){
                        console.log(data);
                        if(data.resultCode=='0000'){
                            callback(data.object.rows);
                        }
                    },
                    error:function(xhr, errorType, error){
                        loader.hide();
                        error = error?error:'系统错误';
                        tips(error,'tips_center',1500);
                    },
                    complete:function(xhr, status){
                        loader.hide();
                    }
                });
			}
			//生成数据
			function createFragment(ul,data,clearFlag) {
				var li;
				if(clearFlag){
					$(ul).empty();
				}
				for (var i = 0; i < data.length; i++) {
					li = document.createElement('li');
					li.className = 'mui-table-view-cell';
					var tmpHtml = '';
					switch(data[i].profession){
					    case '001':
					        tmpHtml = '<span>在校学生</span>';
					        break;
					    case '002':
					        tmpHtml = '<span>工薪族</span>';
					        break;
					    case '003':
					        tmpHtml = '<span>企业主</span>';
					        break;
			            case '004':
					        tmpHtml = '<span>网店主</span>';
					        break;
					    case '005':
					        tmpHtml = '<span>自由职业者</span>';
					        break;
					    default:
					        tmpHtml = '';
					}
					if(data[i].fixedassets=='1'){//房
						tmpHtml += '<span>有房产</span><span>无车产</span>';
					}else if(data[i].fixedassets=='2'){//车
						tmpHtml += '<span>无房产</span><span>有车产</span>';
					}
					if(data[i].socialsecurity=='1'){//社保
						tmpHtml += '<span>有社保</span>';
					}
					if(data[i].socialinsurance=='1'){//公积金
						tmpHtml += '<span>有公积金</span>';
					}
					if(data[i].creditcard=='1'){//信用卡 
						tmpHtml += '<span>有信用卡</span>';
					}
					var grabBtn = '';
					if(data[i].isRobbed==0){
						grabBtn = '<a href="grab_order_details.html?contractNo='+data[i].applyserialno+'" class="gd_grab_btn">立即抢单</a>';
					}
					li.innerHTML = '<div class="gd_order_item"><div class="gd_o_row"><a href="grab_order_details.html?contractNo='+data[i].applyserialno+'"><div class="gd_o_col gd_o_col1"><div class="gd_o_info1"><span class="gd_o_name">'+data[i].customername+'</span><span class="gd_o_edu"><i>'+data[i].loanamount+'</i>万元</span><span>'+data[i].applycity+'</span><span>月收入'+data[i].monthlyincome+'</span></div><div class="gd_o_info2"><img class="gd_o_flag" src="images/grab_order_04.png" alt="">'+tmpHtml+'</div></div><div class="gd_o_col gd_o_col2"><img class="gd_o_fish" src="images/grab_order_02.png" alt=""><p><span>'+data[i].tossforamt+'</span>鱼币</p></div></a></div><div class="gd_o_row">'+grabBtn+'</div></div>';
					
					$(ul).append(li);
				}
				return ul;
			};
	        //抢单
	        function grabOrder(ordreNum,orderPreice){
	        	console.log(ordreNum);
	        	event.preventDefault();
	        	if(isSaler()){
	        		var parmas = {
						userId:Cookie.get('userId'),
						contractNo:ordreNum,
						snatchAmt:orderPreice
		        	};
					$.ajax({
	                    type:"post",
	                    url:Config.url+"/snatchContractLoan",
	                    data:parmas,
	                    beforeSend:function(xhr, settings){
	                        loader.show();
	                    },
	                    success:function(data, status, xhr){
	                        console.log(data);
	                        if(data.resultCode=='0000'){
	                            callback(data);
	                        }else if(data.resultCode=='9003'){
								tips('鱼币余额不足','tips_center',1500);
	                        }
	                    },
	                    error:function(xhr, errorType, error){
	                        loader.hide();
	                        error = error?error:'系统错误';
	                        tips(error,'tips_center',1500);
	                    },
	                    complete:function(xhr, status){
	                        loader.hide();
	                    }
	                });
	        	}else{
	        		location.href = 'grab_order_sales_certification.html';
	        	}
	        }
	        //判断是否是销售
	        function isSaler(){
	        	var flag = false;
	        	$.ajax({
                    type:"post",
                    url:Config.url+"/checkSalesInfo",
                    data:{userId:Cookie.get('userId')},
                    async:false,
                    beforeSend:function(xhr, settings){
                    },
                    success:function(data, status, xhr){
                        console.log(data);
                        if(data.resultCode=='0000'){
                            flag = true;
                        }
                    },
                    error:function(xhr, errorType, error){
                    },
                    complete:function(xhr, status){
                    }
                });
                return flag;
	        }
		</script>
	</body>

</html>